name: Build grd2stream on Ubuntu

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Cache Miniconda
        id: cache-miniconda
        uses: actions/cache@v3
        with:
          path: ~/miniconda3
          key: miniconda-${{ runner.os }}-${{ hashFiles('environment.yml') }}
          restore-keys: |
            miniconda-${{ runner.os }}-

      - name: Install Miniconda (Linux x86_64)
        if: steps.cache-miniconda.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/miniconda3
          wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
          bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
          rm ~/miniconda3/miniconda.sh

      - name: Initialize Conda
        shell: bash
        run: |
          source ~/miniconda3/etc/profile.d/conda.sh
          conda config --add channels conda-forge
          conda config --set channel_priority strict
          conda create -y -n GMT6 gmt=6* gdal hdf5 netcdf4
          conda activate GMT6
          curl -L https://github.com/tkleiner/grd2stream/releases/download/v0.2.14/grd2stream-0.2.14.tar.gz -o grd2stream-0.2.14.tar.gz
          tar xvfz grd2stream-0.2.14.tar.gz
          cd grd2stream-0.2.14
          export LDFLAGS="-Wl,-rpath,$CONDA_PREFIX/lib"
          ./configure --prefix="$CONDA_PREFIX" --enable-gmt-api
          make && make install
          grd2stream -h