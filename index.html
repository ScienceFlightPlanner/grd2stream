<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>grd2stream Documentation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2D3E50;
            border-bottom: 2px solid #3498DB;
            padding-bottom: 10px;
        }
        h2 {
            color: #2980B9;
            margin-top: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        h3 {
            color: #3498DB;
        }
        code {
            background: #f5f5f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .note {
            background: #e7f5fe;
            border-left: 4px solid #3498DB;
            padding: 10px 15px;
            margin: 20px 0;
        }
        .warning {
            background: #ffeaea;
            border-left: 4px solid #E74C3C;
            padding: 10px 15px;
            margin: 20px 0;
        }
        img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            margin: 10px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>grd2stream â€“ QGIS Plugin</h1>

    <h2>Table of Contents</h2>
    <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#installation">Installation & Requirements</a></li>
        <li><a href="#platform-support">Platform Support</a></li>
        <li><a href="#architecture">Technical Architecture</a></li>
        <li><a href="#usage">Using the Plugin</a></li>
        <li><a href="#presets">Working with Presets</a></li>
        <li><a href="#technical-details">Technical Details</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
        <li><a href="#development">Development Information</a></li>
        <li><a href="#license">License Information</a></li>
    </ul>

    <h2 id="overview">Overview</h2>
    <p>
        The grd2stream QGIS plugin allows users to comfortably generate multiple flowlines from velocity grids by selecting seed points.
        This plugin utilizes GMT6 (Generic Mapping Tools) to ensure compatibility with all GDAL file formats.
    </p>

    <p>
        The core functionality is based on the <code>grd2stream</code> command-line utility, which calculates streamlines from gridded velocity
        fields using Runge-Kutta integration methods.
    </p>

    <h3>Key Features</h3>
    <ul>
        <li>Generate flowlines from any GDAL-compatible X and Y velocity component rasters</li>
        <li>Interactive seed point selection via map clicks or manual coordinate entry</li>
        <li>Configurable integration parameters (step size, max steps, etc.)</li>
        <li>Save and load parameter presets for repeated use</li>
        <li>Isolated GMT6 environment that doesn't interfere with existing installations</li>
    </ul>

    <h2 id="installation">Installation & Requirements</h2>

    <h3>QGIS Plugin Installation</h3>
    <ol>
        <li>Open QGIS</li>
        <li>Go to Plugins â†’ Manage and Install Plugins</li>
        <li>Search for "grd2stream"</li>
        <li>Click "Install Plugin"</li>
    </ol>

    <h3>Dependencies</h3>
    <p>
        The plugin requires:
    </p>
    <ul>
        <li>QGIS 3.0 or higher</li>
        <li>GMT6 (Generic Mapping Tools version 6)</li>
        <li>grd2stream command-line utility</li>
    </ul>

    <div class="note">
        <strong>Note:</strong> On Linux and macOS, the plugin can automatically install these dependencies in an isolated Miniconda environment.
    </div>

    <h2 id="platform-support">Platform Support</h2>

    <h3>Current Status</h3>
    <table>
        <tr>
            <th>Platform</th>
            <th>Status</th>
            <th>Notes</th>
        </tr>
        <tr>
            <td>Linux</td>
            <td>âœ… Fully Supported</td>
            <td>Automatic installation of dependencies via Miniconda</td>
        </tr>
        <tr>
            <td>macOS</td>
            <td>âœ… Fully Supported</td>
            <td>Automatic installation of dependencies via Miniconda</td>
        </tr>
        <tr>
            <td>Windows</td>
            <td>ðŸš§ In Development</td>
            <td>Currently only planning/parameter configuration available. Command execution not yet supported.</td>
        </tr>
    </table>

    <h3>Windows Limitations</h3>
    <p>
        On Windows, the plugin currently cannot execute the grd2stream command. However, you can still:
    </p>
    <ul>
        <li>Configure all parameters and settings</li>
        <li>Save and manage presets</li>
        <li>View the command that would be executed (for reference)</li>
    </ul>

    <p>
        Full Windows support is being developed and will be available in a future update.
    </p>

    <h2 id="architecture">Technical Architecture</h2>

    <h3>Component Overview</h3>
    <p>
        The plugin consists of several key components:
    </p>

    <ul>
        <li><strong>QGIS Plugin Interface</strong> - The UI components that integrate with QGIS</li>
        <li><strong>Flowline Module</strong> - Core functionality for generating flowlines</li>
        <li><strong>Preset Manager</strong> - Handles saving and loading of parameter configurations</li>
        <li><strong>Conda Environment Management</strong> - Handles installation and management of GMT6 and grd2stream</li>
    </ul>

    <h3>Dependency Management</h3>
    <p>
        On Linux and macOS, the plugin:
    </p>
    <ol>
        <li>Installs Miniconda3 to <code>~/miniconda3</code> (if not already installed)</li>
        <li>Creates a "GMT6" Conda environment with GMT6 and required dependencies</li>
        <li>Installs the grd2stream utility in the Conda environment</li>
    </ol>

    <p>
        This approach ensures that:
    </p>
    <ul>
        <li>The plugin works without requiring system-wide installation of GMT6</li>
        <li>The plugin's dependencies don't interfere with existing installations</li>
        <li>No administrator privileges are required for installation</li>
    </ul>

    <h2 id="usage">Using the Plugin</h2>

    <h3>Basic Workflow</h3>
    <ol>
        <li>Click the grd2stream icon in the QGIS toolbar</li>
        <li>If this is your first time using the plugin on Linux or macOS, you may be prompted to install dependencies</li>
        <li>Select input rasters:
            <ul>
                <li>Raster 1: X-component of velocity</li>
                <li>Raster 2: Y-component of velocity</li>
                <li>For multi-band rasters, select the appropriate band for each component</li>
            </ul>
        </li>
        <li>Configure parameters or load a preset</li>
        <li>Click OK to proceed to seed point selection</li>
        <li>Choose a method to select the seed point:
            <ul>
                <li>Click on the map</li>
                <li>Enter coordinates manually</li>
            </ul>
        </li>
        <li>The plugin will calculate the flowline and add it to your project as a vector layer</li>
    </ol>

    <h3>Parameter Configuration</h3>
    <h4>Required Parameters</h4>
    <ul>
        <li><strong>Raster 1 & Raster 2:</strong> The X and Y component rasters</li>
        <li><strong>Seed Point:</strong> The starting location for the flowline</li>
    </ul>

    <h4>Optional Parameters</h4>
    <ul>
        <li><strong>Backward Steps:</strong> Enable to trace the flowline in both upstream and downstream directions</li>
        <li><strong>Step Size:</strong> Distance increment for integration steps (default is min(x_inc, y_inc) / 5)</li>
        <li><strong>Max Integration Time:</strong> Maximum time for the integration process</li>
        <li><strong>Max Steps:</strong> Maximum number of steps to calculate (default is 10,000)</li>
        <li><strong>Output Format:</strong> Choose what data columns to include in the output layer</li>
    </ul>

    <h3>Output Formats</h3>
    <ul>
        <li><strong>Default (no option):</strong> x y dist
            <ul>
                <li>X and Y coordinates</li>
                <li>Distance along the flowline</li>
            </ul>
        </li>
        <li><strong>Extended (-l):</strong> x y dist v_x v_y
            <ul>
                <li>All default columns</li>
                <li>X and Y velocity components at each point</li>
            </ul>
        </li>
        <li><strong>Full (-t):</strong> x y dist v_x v_y time
            <ul>
                <li>All extended columns</li>
                <li>Integration time for each point</li>
            </ul>
        </li>
    </ul>

    <h2 id="presets">Working with Presets</h2>

    <h3>Saving Presets</h3>
    <p>
        To save your current configuration as a preset:
    </p>
    <ol>
        <li>Configure parameters in the main dialog</li>
        <li>Click "Save as Preset"</li>
        <li>Enter a name for your preset</li>
        <li>Confirm to save</li>
    </ol>

    <h3>Loading Presets</h3>
    <p>
        To load a saved preset:
    </p>
    <ol>
        <li>Click "Load Preset" in the main dialog</li>
        <li>Select a preset from the list</li>
        <li>Click "Select"</li>
    </ol>

    <h3>Managing Presets</h3>
    <p>
        The preset management dialog allows you to:
    </p>
    <ul>
        <li><strong>View:</strong> See detailed settings for each preset</li>
        <li><strong>Edit:</strong> Modify parameters for existing presets</li>
        <li><strong>Delete:</strong> Remove presets that are no longer needed</li>
    </ul>

    <h3>Using Last Settings</h3>
    <p>
        The "Use Last Settings" button quickly reapplies:
    </p>
    <ul>
        <li>The last manually configured settings, or</li>
        <li>The last preset that was used</li>
    </ul>

    <div class="note">
        <strong>Note:</strong> Presets are stored in a <code>presets.json</code> file in the plugin directory and persist between QGIS sessions.
    </div>

    <h2 id="technical-details">Technical Details</h2>

    <h3>Integration Method</h3>
    <p>
        The plugin uses the grd2stream utility, which implements:
    </p>
    <ul>
        <li>4th-order Runge-Kutta integration method</li>
        <li>Adaptive step size control (optional)</li>
        <li>Bi-linear interpolation between grid points</li>
    </ul>

    <h3>Supported File Formats</h3>
    <p>
        The plugin can work with any raster format supported by GDAL, including:
    </p>
    <ul>
        <li>GeoTIFF</li>
        <li>NetCDF</li>
        <li>HDF5</li>
        <li>GRIB</li>
        <li>ASCII Grid</li>
        <li>Many others</li>
    </ul>

    <div class="note">
        <strong>Tip:</strong> For NetCDF and similar multi-dimensional formats, you can select the specific variable by choosing the appropriate band in the input dialog.
    </div>

    <h3>Output Processing</h3>
    <p>
        The plugin:
    </p>
    <ol>
        <li>Executes the grd2stream command with the specified parameters</li>
        <li>Captures the command output (a text stream of coordinates and attributes)</li>
        <li>Parses the output and converts it to a QGIS vector layer</li>
        <li>Adds the vector layer to the current project</li>
    </ol>

    <h2 id="troubleshooting">Troubleshooting</h2>

    <h3>Common Issues</h3>

    <h4>No Flowline Generated</h4>
    <ul>
        <li><strong>Issue:</strong> Plugin runs but no flowline appears</li>
        <li><strong>Possible causes:</strong>
            <ul>
                <li>Seed point placed in an area with zero or undefined velocity</li>
                <li>Input rasters don't represent valid velocity components</li>
                <li>Step size too large for the data resolution</li>
            </ul>
        </li>
        <li><strong>Solutions:</strong>
            <ul>
                <li>Try a different seed point location</li>
                <li>Verify raster data represents X and Y velocity components</li>
                <li>Reduce step size</li>
            </ul>
        </li>
    </ul>

    <h4>Installation Problems</h4>
    <ul>
        <li><strong>Issue:</strong> Dependency installation fails</li>
        <li><strong>Possible causes:</strong>
            <ul>
                <li>Network connectivity issues</li>
                <li>Insufficient disk space</li>
                <li>Permission issues in home directory</li>
            </ul>
        </li>
        <li><strong>Solutions:</strong>
            <ul>
                <li>Check internet connection</li>
                <li>Ensure at least 1GB free disk space</li>
                <li>Check QGIS Python console for detailed error messages</li>
            </ul>
        </li>
    </ul>

    <h4>Windows Support</h4>
    <ul>
        <li><strong>Issue:</strong> Plugin shows command but doesn't execute it</li>
        <li><strong>Cause:</strong> Windows execution support is still under development</li>
        <li><strong>Solution:</strong> Currently not available; Windows support will be added in a future update</li>
    </ul>

    <h3>Checking Logs</h3>
    <p>
        For detailed troubleshooting:
    </p>
    <ol>
        <li>Open the QGIS Python Console (Plugins â†’ Python Console)</li>
        <li>Look for messages related to grd2stream</li>
        <li>Check detailed execution logs and error messages</li>
    </ol>

    <h2 id="development">Development Information</h2>

    <h3>Plugin Structure</h3>
    <p>
        The plugin code is organized as follows:
    </p>
    <ul>
        <li><strong>__init__.py</strong> - Plugin initialization</li>
        <li><strong>grd_2_stream.py</strong> - Main plugin class and QGIS integration</li>
        <li><strong>flowline_module.py</strong> - Core functionality</li>
        <li><strong>dialog_selection.py</strong> - UI for parameter selection</li>
        <li><strong>dialog_preset.py</strong> - UI for preset management</li>
        <li><strong>help_widget.py</strong> - Help documentation display</li>
    </ul>

    <h3>Contributing</h3>
    <p>
        Contributions to the plugin are welcome! Priority areas include:
    </p>
    <ul>
        <li>Windows support implementation</li>
    </ul>

    <h2 id="license">License Information</h2>

    <h3>Plugin License</h3>
    <p>
        The grd2stream QGIS plugin is licensed under the GNU General Public License v3.0 (GPL-3.0).
    </p>

    <h3>Third-Party Components</h3>
    <p>
        The plugin includes:
    </p>
    <ul>
        <li><strong>grd2stream</strong> command-line tool by Thomas Kleiner:
            <ul>
                <li>Licensed under the BSD 3-Clause License</li>
                <li>See the full license text in <code>lib/LICENSE.txt</code></li>
            </ul>
        </li>
    </ul>

    <h3>Copyright</h3>
    <p>
        Â© 2013-2025 Thomas Kleiner & ScienceFlightPlanner-Team
    </p>
</body>
</html>